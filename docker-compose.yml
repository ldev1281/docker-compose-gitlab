services:
  gitlab-app:
    image: gitlab/gitlab-ee:${GITLAB_VERSION}
    container_name: gitlab-app
    restart: unless-stopped
    hostname: ${GITLAB_HOSTNAME}
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url '${GITLAB_EXTERNAL_URL}'
        nginx['listen_port'] = ${GITLAB_INTERNAL_HTTP_PORT}
        nginx['listen_https'] = false
        nginx['redirect_http_to_https'] = false
        gitlab_rails['gitlab_shell_ssh_port'] = ${GITLAB_SSH_PORT}
        gitlab_rails['smtp_enable'] = ${GITLAB_SMTP_ENABLE}
        gitlab_rails['smtp_address'] = '${GITLAB_SMTP_HOST}'
        gitlab_rails['smtp_port'] = ${GITLAB_SMTP_PORT}
        gitlab_rails['smtp_user_name'] = '${GITLAB_SMTP_USERNAME}'
        gitlab_rails['smtp_password'] = '${GITLAB_SMTP_PASSWORD}'
        gitlab_rails['smtp_domain'] = '${GITLAB_SMTP_HOST}'
        gitlab_rails['smtp_authentication'] = '${GITLAB_SMTP_AUTH}'
        gitlab_rails['smtp_enable_starttls_auto'] = ${GITLAB_SMTP_STARTTLS}
        gitlab_rails['smtp_tls'] = ${GITLAB_SMTP_TLS}
        gitlab_rails['gitlab_email_from'] = '${GITLAB_SMTP_USERNAME}'
        gitlab_rails['gitlab_email_display_name'] = '${GITLAB_EMAIL_DISPLAY_NAME}'
        registry['enable'] = true
        registry_external_url '${GITLAB_REGISTRY_URL}'
        registry_nginx['enable'] = true
        registry_nginx['listen_port'] = ${GITLAB_INTERNAL_REGISTRY_PORT}
        registry_nginx['listen_https'] = false
    shm_size: "${GITLAB_SHM_SIZE}"
    volumes:
      - ./vol/gitlab/etc:/etc/gitlab
      - ./vol/gitlab/log:/var/log/gitlab
      - ./vol/gitlab/data:/var/opt/gitlab

    networks:
      - proxy-client-gitlab

networks:
  proxy-client-gitlab:
    name: proxy-client-gitlab
    external: true