name: Validate CURRENT_GITLAB_VERSION
on:
  pull_request:
    branches:
      - main
    paths:
      - 'tools/init.bash'
jobs:
  validate-version:
    runs-on: ubuntu-latest
    steps:
      - name: Check out
        uses: actions/checkout@v4
      - name: Validate CURRENT_GITLAB_VERSION is not empty
        env:
          DOCKER_REPO: gitlab/gitlab-ee
        run: |
          APP_VERSION=$(grep -oP '^CURRENT_GITLAB_VERSION="\K[^"]+' tools/init.bash)
          if [ -z "$APP_VERSION" ]; then
            echo "ERROR: failed to parse CURRENT_GITLAB_VERSION"
            exit 1
          fi
          URL="https://hub.docker.com/v2/repositories/${DOCKER_REPO}/tags/${APP_VERSION}"
          echo "Checking if tag ${DOCKER_REPO}:${APP_VERSION} exists on Docker Hub..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "::error::Tag '${APP_VERSION}' not found for image '${DOCKER_REPO}' on Docker Hub (HTTP ${HTTP_CODE}). Check CURRENT_GITLAB_VERSION."
            exit 1
          fi
          echo "OK: Image ${DOCKER_REPO}:${APP_VERSION} found on Docker Hub."